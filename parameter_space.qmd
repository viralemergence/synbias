---
title: "Exploring the Parameter Space"
author: "July Pilowsky"
---

```{r setup, echo = F, include = F}
library(tidyverse)
library(scales)
library(paletteer)
library(cowplot)
library(Rcpp)
library(RcppArmadillo)
library(furrr)
theme_set(theme_cowplot())
source("lhs.R")
source("simulation_functions.R")
set.seed(185)
simulation <- FALSE
```

# The Parameter Space

I am exploring the parameter space in four ways. I am exploring the effects of interaction strength, ratio of competitive to facilitative interactions, number of strains, and presence/absence of priority effects.

Aspects of simulations I am *not* changing are the population size, number of time steps, baseline transmission rate, or method of imperfect sampling.

# Simulation

```{r simulate}
if (simulation) {
  plan(multisession, workers = 15)
  imperfect_samples <-
    sample_data %>% rowwise() %>% group_split() %>%
    map(df_to_inputs) %>%
    future_map(\(x) {
      sourceCpp("ferrari.cpp")
      mat <- ferrari(x$initial_pop, x$interactions, 2e-04, 100)
      disease_sample(mat, prop = 0.1, imperfect_assays = FALSE)
    }, .progress = T, seed = NULL)
  results <- sample_data %>%
    mutate(richness_count = map_dbl(imperfect_samples, sum))
  write_csv(results, "simulation_round1.csv")
} else {
  results <- read_csv("simulation_round1.csv", show_col_types = F)
}
head(results)
```

# Visualization

```{r strains}
ggplot(results, aes(x = strains, y = richness_count, col = cf_ratio)) +
  geom_point() +
  scale_color_paletteer_c("scico::vikO", name = "C:F Ratio") +
  xlab("True Strain Number") +
  ylab("Measured Strain Number") +
  ggtitle("True vs. Measured Viral Richness")
results |> 
  mutate(underestimate = richness_count/strains*100) |> 
  ggplot(aes(x = strains, y = underestimate, col = cf_ratio)) +
  geom_point() +
  scale_color_paletteer_c("scico::vikO", name = "C:F Ratio") +
  xlab("Strain Number") +
  ylab("% Underestimate of True Richness") +
  ggtitle("Effect of Strain Number on Bias")
```

```{r interaction strength}
results |> mutate(underestimate = richness_count/strains*100) |> 
  ggplot(aes(x = cf_ratio, y = underestimate, col = interaction_strength)) +
  scale_color_paletteer_c("scico::oslo", direction = -1, 
                          name = "Interaction\nStrength") +
  geom_point() +
  xlab("C:F Ratio") +
  ylab("% Underestimate of True Richness") +
  ggtitle("Effect of Interaction Strength on Bias")
```

```{r priority effects}
results |> mutate(underestimate = richness_count/strains*100) |> 
  ggplot(aes(x = priority_effects, y = underestimate, 
             fill = priority_effects)) +
  scale_fill_paletteer_d("nbapalettes::heat_vice") +
  geom_violin() +
  xlab("Priority Effects") +
  ylab("% Underestimate of True Richness") +
  theme(legend.position = "none")
```
